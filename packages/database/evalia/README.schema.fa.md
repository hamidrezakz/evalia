# مستند فنی دیتابیس سازمانی Evalia (مرحله اول)

این مستند برای ارائه به مدیر پروژه تهیه شده و به‌صورت دقیق توضیح می‌دهد که در فاز اول پروژه، چه جداول و ساختارهایی در پایگاه داده (بر اساس Prisma/PostgreSQL) پیاده‌سازی شده و هر بخش چه کاربردی دارد. این ساختار کاملاً استاندارد و توسعه‌پذیر طراحی شده تا در آینده به‌راحتی قابلیت افزودن امکانات جدید (مانند تسک، آزمون، پیام‌رسانی و ...) وجود داشته باشد.

---

## اهداف فاز اول

- پشتیبانی کامل از چندسازمانی (Multi-Tenant)
- مدیریت کاربران، نقش‌ها و سطوح دسترسی (RBAC)
- ساختاردهی سازمانی (تیم، دپارتمان، پروفایل کارمند)
- مدیریت منوی داینامیک داشبورد بر اساس نقش
- سیستم دعوت و عضویت
- سیستم تأیید (Approval) و بازخورد (Feedback)
- اعلان (Notification) و لاگ فعالیت (Audit)
- تنظیمات سازمانی قابل توسعه

---

## لیست جداول و کاربرد هرکدام

### 1. User

- هویت کاربر سراسری (می‌تواند عضو چند سازمان باشد)
- اطلاعات: ایمیل، رمزعبور، نام نمایشی، وضعیت، آواتار، زبان، منطقه زمانی، متادیتا
- روابط: عضویت‌ها، نقش‌های ساخته‌شده، پروفایل‌های کارمندی، درخواست‌ها و تصمیمات تأیید، بازخوردها، اعلان‌ها، عضویت تیم، دعوت‌نامه‌های ارسال‌شده، لاگ فعالیت

### 2. Organization

- ریشه هر سازمان (tenant)
- اطلاعات: نام، اسلاگ (یونیک)، توضیحات، لوگو، متادیتا
- روابط: عضویت‌ها، نقش‌ها، تیم‌ها، دپارتمان‌ها، پروفایل‌های کارمندی، آیتم‌های منو، دعوت‌نامه‌ها، درخواست‌های تأیید، بازخوردها، اعلان‌ها، لاگ‌ها، تنظیمات

### 3. OrgMembership

- اتصال کاربر به سازمان (هر کاربر می‌تواند عضو چند سازمان باشد)
- اطلاعات: تاریخ عضویت، پرایمری بودن
- روابط: نقش‌های تخصیص‌یافته

### 4. Role / Permission / RolePermission / RoleAssignment

- سیستم نقش و مجوز (RBAC)
- Role: نقش‌های هر سازمان (مثلاً Admin, Manager, Employee)
- Permission: اتم مجوز (مثلاً CREATE_USER)
- RolePermission: اتصال نقش به مجوز
- RoleAssignment: تخصیص نقش به عضویت کاربر در سازمان (با تاریخ انقضا)

### 5. Team / TeamMember

- ساختار تیمی (تیم‌های تو در تو)
- Team: تعریف تیم با parentId برای ساختار سلسله‌مراتبی
- TeamMember: عضویت کاربر در تیم

### 6. Department

- دپارتمان‌های سازمانی (ساده، قابل توسعه)

### 7. EmployeeProfile

- پروفایل کارمندی هر کاربر در هر سازمان (HR)
- اطلاعات: دپارتمان، مدیر مستقیم، عنوان شغلی، وضعیت، تاریخ شروع/پایان، متادیتا

### 8. DashboardMenuItem / DashboardMenuItemRole

- تعریف منوی داینامیک داشبورد (درختی)
- اتصال هر آیتم منو به نقش‌های مجاز برای نمایش

### 9. Invitation

- مدیریت دعوت‌نامه‌ها (عضویت با ایمیل و نقش پیشنهادی)
- وضعیت: Pending, Accepted, Revoked, Expired

### 10. ApprovalRequest

- سیستم تأیید (برای هر نوع درخواست سازمانی)
- اطلاعات: نوع، وضعیت، درخواست‌دهنده، تصمیم‌گیرنده، payload جزییات

### 11. Feedback

- بازخورد کارمند به کارمند یا سازمان
- نوع: General, Performance, Peer, Manager, Self

### 12. Notification

- اعلان‌های کاربر (درون‌برنامه‌ای یا ایمیل)

### 13. AuditLog

- ثبت لاگ فعالیت‌های مهم (چه کسی، چه کاری، روی چه منبعی)

### 14. OrgSetting

- تنظیمات کلید-مقدار برای هر سازمان (قابل توسعه برای feature flag و ...)

---

## ویژگی‌های کلیدی طراحی

- **Multi-Tenant واقعی:** هر داده سازمانی کلید orgId دارد.
- **Soft Delete:** حذف نرم با فیلد deletedAt (برای جلوگیری از حذف فیزیکی داده‌ها)
- **ایندکس و یونیک:** روی فیلدهای کلیدی (مانند ایمیل، اسلاگ، کلید منو، ...)
- **Enums:** برای وضعیت‌ها، نوع مجوز، نوع بازخورد و ...
- **قابلیت توسعه:** ساختار آماده برای افزودن Task، آزمون، پیام‌رسانی، یکپارچه‌سازی و ...
- **متادیتا (Json):** برای انعطاف در ذخیره اطلاعات اضافی بدون تغییر ساختار اصلی

---

## مسیر توسعه آینده

- افزودن ماژول‌های Task، آزمون، پیام‌رسانی، یکپارچه‌سازی با Slack/Microsoft و هوش مصنوعی
- توسعه سیستم مجوز و نقش‌ها بر اساس نیازهای دقیق‌تر سازمان
- افزودن partial unique index در صورت نیاز (برای حذف نرم پیشرفته)
- بهبود performance روی جداول حجیم (AuditLog, Notification)

---

## نتیجه‌گیری

این ساختار دیتابیس، پایه‌ای بسیار استاندارد و توسعه‌پذیر برای هر نوع سیستم سازمانی مدرن است و به‌راحتی می‌توان امکانات جدید را به آن افزود یا آن را با نیازهای خاص هر سازمان تطبیق داد. هرگونه تغییر یا توسعه بعدی به‌سادگی قابل انجام است.

---

> هر سوال یا نیاز به توضیح بیشتر بود، در دسترس هستم.
